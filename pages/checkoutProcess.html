<!-- Main Checkout Container -->
<div class="bg-white rounded-3xl shadow-lg w-full max-w-md overflow-y-auto mx-auto" id="checkout-main-container">

    <!-- Dynamic Header Section -->
    <div id="checkout-header" class="bg-gradient-to-r from-green-500 to-green-600 p-4 text-white flex items-center justify-between rounded-t-3xl relative">
        <h1 class="text-xl font-semibold"></h1>
        <span id="items-count" class="bg-white text-green-700 px-3 py-1 rounded-full text-sm font-medium hidden">0 Items</span>
    </div>

    <!-- Dynamic Progress Steps Section -->
    <div class="flex justify-around items-center p-4 bg-gray-50 border-b border-gray-100">
        <div id="cart-step" class="flex flex-col items-center text-gray-400 transition-colors duration-300">
            <i class="fas fa-shopping-cart text-2xl mb-1"></i>
            <span class="text-xs font-medium">Cart</span>
        </div>
        <div id="cart-address-line" class="flex-1 border-t-2 border-gray-300 mx-2 transition-colors duration-300"></div>
        <div id="address-step" class="flex flex-col items-center text-gray-400 transition-colors duration-300">
            <i class="fas fa-map-marker-alt text-2xl mb-1"></i>
            <span class="text-xs font-medium">Address</span>
        </div>
        <div id="address-summary-line" class="flex-1 border-t-2 border-gray-300 mx-2 transition-colors duration-300"></div>
        <div id="summary-step" class="flex flex-col items-center text-gray-400 transition-colors duration-300">
            <i class="fas fa-file-invoice-dollar text-2xl mb-1"></i>
            <span class="text-xs font-medium">Summary</span>
        </div>
        <div id="summary-payment-line" class="flex-1 border-t-2 border-gray-300 mx-2 transition-colors duration-300"></div>
        <div id="payment-step" class="flex flex-col items-center text-gray-400 transition-colors duration-300">
            <i class="fas fa-credit-card text-2xl mb-1"></i>
            <span class="text-xs font-medium">Payment</span>
        </div>
    </div>

    <!-- Step 0: Shopping Cart -->
    <div class="checkout" id="step0">
        <!-- Store Name Section -->
        <div class="p-4 flex items-center space-x-3 bg-gray-50 border-b border-gray-100">
            <!-- AniMo Logo Placeholder -->
            <img src="https://placehold.co/40x40/C4E0C1/000?text=AniMo" alt="AniMo Logo" class="w-10 h-10 rounded-full object-cover">
            <h2 class="text-xl font-semibold text-gray-800">AniMo Vegetables</h2>
        </div>

        <!-- Cart Items Section - Will be dynamically populated -->
        <div id="cart-items-container" class="p-4 space-y-4">
            <!-- Product items will be injected here by JavaScript -->
        </div>

        <!-- Order Summary Section -->
        <div class="p-4 bg-gray-50 rounded-b-3xl">
            <div class="flex justify-between items-center text-gray-700 text-sm mb-2">
                <span>SUB Total :</span>
                <span id="sub-total-display">₱ 0.00</span>
            </div>
            <div class="flex justify-between items-center text-gray-700 text-sm mb-4">
                <span>Delivery Charges :</span>
                <span id="delivery-charges-display">₱ 50.00</span>
            </div>
            <div class="flex justify-between items-center text-green-700 font-bold text-lg mb-6">
                <span>Order Total :</span>
                <span id="order-total-display">₱ 0.00</span>
            </div>

            <!-- Secure Checkout Button -->
            <button class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-full shadow-lg transition duration-300 ease-in-out transform hover:scale-105 continue-btn">
                Secure Checkout
            </button>
        </div>
    </div>

    <!-- Step 1: Address Selection -->
    <div class="checkout" id="step1">
        <div class="p-4 space-y-4 bg-gray-100">
            <!-- Current Address Display (Common to all steps) -->
            <div class="relative bg-white rounded-xl shadow-lg p-4 border-2 border-green-500">
                <div class="absolute top-3 right-3 text-green-500">
                    <i class="fas fa-check-circle text-xl"></i>
                </div>
                <p class="font-semibold text-gray-900 mb-1">Abdul Salsal</p>
                <p class="text-sm text-gray-600">Metro Manila, Philippines</p>
                <p class="text-sm text-gray-600">1839</p>
                <p class="text-sm text-gray-600 mb-3">+68 900909090</p>
                <div class="flex justify-end">
                    <button class="text-blue-500 hover:text-blue-600 text-sm font-medium change-address-btn">Change</button>
                </div>
            </div>

            <!-- Address Selection Options -->
            <div class="content space-y-4">
                <div class="address-card bg-white rounded-xl shadow-md p-4 border border-gray-200 transition-all duration-300 ease-in-out cursor-pointer hover:scale-[1.02] active" data-address-type="work">
                    <div class="flex items-center space-x-3 mb-2 text-gray-800">
                        <i class="fas fa-building text-xl"></i>
                        <h3 class="font-semibold text-lg">WORK</h3>
                    </div>
                    <p class="text-sm text-gray-800 font-medium">ABDUL SAL SAL</p>
                    <p class="text-sm text-gray-600">+68 90 03243295</p>
                    <p class="text-sm text-gray-600">BGC , TAGUIG CITY PHILIPPINES</p>
                </div>
                <div class="address-card bg-white rounded-xl shadow-md p-4 border border-gray-200 transition-all duration-300 ease-in-out cursor-pointer hover:scale-[1.02]" data-address-type="home">
                    <div class="flex items-center space-x-3 mb-2 text-gray-800">
                        <i class="fas fa-home text-xl"></i>
                        <h3 class="font-semibold text-lg">HOME</h3>
                    </div>
                    <p class="text-sm text-gray-800 font-medium">ABDUL SAL SAL</p>
                    <p class="text-sm text-gray-600">+68 90 03243295</p>
                    <p class="text-sm text-gray-600">LAGUNA, PHILIPPINES</p>
                </div>
            </div>
        </div>

        <!-- Buttons for Step 1 -->
        <div class="p-4 bg-white rounded-b-3xl flex justify-between space-x-4">
            <button class="back-btn flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 px-4 rounded-full shadow-lg transition duration-300 ease-in-out transform hover:scale-105">
                Back
            </button>
            <button class="continue-btn flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-full shadow-lg transition duration-300 ease-in-out transform hover:scale-105">
                Continue
            </button>
        </div>
    </div>

    <!-- Step 2: Order Summary -->
    <div class="checkout" id="step2">
        <div class="p-4 space-y-4 bg-gray-100">
            <!-- Current Address Display -->
            <div class="relative bg-white rounded-xl shadow-lg p-4 border-2 border-green-500">
                <div class="absolute top-3 right-3 text-green-500">
                    <i class="fas fa-check-circle text-xl"></i>
                </div>
                <p class="font-semibold text-gray-900 mb-1">Abdul Salsal</p>
                <p class="text-sm text-gray-600">Metro Manila, Philippines</p>
                <p class="text-sm text-gray-600">1839</p>
                <p class="text-sm text-gray-600 mb-3">+68 900909090</p>
                <div class="flex justify-end">
                    <button class="text-blue-500 hover:text-blue-600 text-sm font-medium change-address-btn">Change</button>
                </div>
            </div>

            <!-- Product Summary Section - Will be dynamically populated -->
            <div id="summary-items-container" class="item-container bg-white rounded-xl shadow-md overflow-hidden">
                <!-- Product items will be injected here by JavaScript -->
            </div>
        </div>

        <!-- Buttons for Step 2 -->
        <div class="p-4 bg-white rounded-b-3xl flex justify-between space-x-4">
            <button class="back-btn flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 px-4 rounded-full shadow-lg transition duration-300 ease-in-out transform hover:scale-105">
                Back
            </button>
            <button class="continue-btn flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-full shadow-lg transition duration-300 ease-in-out transform hover:scale-105">
                Payment
            </button>
        </div>
    </div>

    <!-- Step 3: Payment Options -->
    <div class="checkout" id="step3">
        <div class="p-4 space-y-4 bg-gray-100">
            <!-- Current Address Display -->
            <div class="relative bg-white rounded-xl shadow-lg p-4 border-2 border-green-500">
                <div class="absolute top-3 right-3 text-green-500">
                    <i class="fas fa-check-circle text-xl"></i>
                </div>
                <p class="font-semibold text-gray-900 mb-1">Abdul Salsal</p>
                <p class="text-sm text-gray-600">Metro Manila, Philippines</p>
                <p class="text-sm text-gray-600">1839</p>
                <p class="text-sm text-gray-600 mb-3">+68 900909090</p>
                <div class="flex justify-end">
                    <button class="text-blue-500 hover:text-blue-600 text-sm font-medium change-address-btn">Change</button>
                </div>
            </div>

            <!-- Payment Options -->
            <div class="content space-y-4">
                <div class="payment-option-card bg-white rounded-xl shadow-md p-4 border border-gray-200 transition-all duration-300 ease-in-out cursor-pointer hover:scale-[1.02]" data-payment-type="cod">
                    <div class="flex items-center space-x-3 mb-1 text-gray-800">
                        <i class="fas fa-truck text-xl"></i>
                        <h3 class="font-semibold text-lg">Cash On Delivery</h3>
                    </div>
                    <p class="text-sm text-gray-600">Additional 20 Charges for COD services</p>
                </div>
                <div class="payment-option-card bg-white rounded-xl shadow-md p-4 border border-gray-200 transition-all duration-300 ease-in-out cursor-pointer hover:scale-[1.02]" data-payment-type="credit">
                    <div class="flex items-center space-x-3 mb-1 text-gray-800">
                        <i class="fas fa-credit-card text-xl"></i>
                        <h3 class="font-semibold text-lg">CREDIT CARD</h3>
                    </div>
                    <p class="text-sm text-gray-900 font-medium">ABDUL SAL SAL</p>
                    <p class="text-sm text-gray-700">+68 90 03898***</p>
                </div>
            </div>

            <!-- Promo Code Section -->
            <div class="p-2 text-gray-700">
                <p>Do you have a promo code?</p>
            </div>
        </div>

        <!-- Buttons for Step 3 -->
        <div class="p-4 bg-white rounded-b-3xl flex justify-between space-x-4">
            <button class="back-btn flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 px-4 rounded-full shadow-lg transition duration-300 ease-in-out transform hover:scale-105">
                Back
            </button>
            <button class="checkout-btn flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-full shadow-lg transition duration-300 ease-in-out transform hover:scale-105">
                Place Order
            </button>
        </div>
    </div>
</div>

<!-- All JavaScript for checkout process moved here -->
<script>
    // Define all steps with their corresponding headers and optional item counts
    const steps = [
        { id: 'step0', header: 'Your Cart', showItemsCount: true },
        { id: 'step1', header: 'Check Out 1/4', showItemsCount: false },
        { id: 'step2', header: 'Check Out 2/4', showItemsCount: false },
        { id: 'step3', header: 'Check Out 3/4', showItemsCount: false }
    ];
    let currentStepIndex = 0; // Start at step 0 (cart)
    let cartItems = []; // Array to hold products in the cart

    const DELIVERY_CHARGE = 50.00;

    // Function to update header and progress indicators
    function updateUIForStep(index) {
        console.log(`[checkoutProcess.html] updateUIForStep called for index: ${index}`);
        const checkoutMainContainer = document.getElementById('checkout-main-container');
        if (!checkoutMainContainer) {
            console.warn("[checkoutProcess.html] Checkout main container not found in updateUIForStep. Skipping UI update for steps.");
            return;
        }

        const headerElement = checkoutMainContainer.querySelector('#checkout-header h1');
        const itemsCountElement = checkoutMainContainer.querySelector('#items-count');
        const cartStep = checkoutMainContainer.querySelector('#cart-step');
        const addressStep = checkoutMainContainer.querySelector('#address-step');
        const summaryStep = checkoutMainContainer.querySelector('#summary-step');
        const paymentStep = checkoutMainContainer.querySelector('#payment-step');
        const cartAddressLine = checkoutMainContainer.querySelector('#cart-address-line');
        const addressSummaryLine = checkoutMainContainer.querySelector('#address-summary-line');
        const summaryPaymentLine = checkoutMainContainer.querySelector('#summary-payment-line');

        // Check if all elements are found
        if (!headerElement || !itemsCountElement || !cartStep || !addressStep || !summaryStep || !paymentStep || !cartAddressLine || !addressSummaryLine || !summaryPaymentLine) {
            console.error("[checkoutProcess.html] One or more checkout UI elements not found in updateUIForStep. This may be a timing issue.");
            return;
        }

        // Update header text
        headerElement.textContent = steps[index].header;

        // Update items count dynamically for step0
        if (index === 0) {
            itemsCountElement.textContent = `${cartItems.length} Item${cartItems.length !== 1 ? 's' : ''}`;
            itemsCountElement.classList.remove('hidden');
        } else if (steps[index].showItemsCount) {
            itemsCountElement.classList.remove('hidden');
        } else {
            itemsCountElement.classList.add('hidden');
        }

        // Reset all progress indicators to gray
        [cartStep, addressStep, summaryStep, paymentStep].forEach(el => {
            el.classList.remove('text-green-600');
            el.classList.add('text-gray-400');
        });
        [cartAddressLine, addressSummaryLine, summaryPaymentLine].forEach(el => {
            el.classList.remove('border-green-400');
            el.classList.add('border-gray-300');
        });

        // Apply active styles based on current step
        if (index >= 0) {
            cartStep.classList.remove('text-gray-400');
            cartStep.classList.add('text-green-600');
        }
        if (index >= 1) {
            cartAddressLine.classList.remove('border-gray-300');
            cartAddressLine.classList.add('border-green-400');
            addressStep.classList.remove('text-gray-400');
            addressStep.classList.add('text-green-600');
        }
        if (index >= 2) {
            addressSummaryLine.classList.remove('border-gray-300');
            addressSummaryLine.classList.add('border-green-400');
            summaryStep.classList.remove('text-gray-400');
            summaryStep.classList.add('text-green-600');
        }
        if (index >= 3) {
            summaryPaymentLine.classList.remove('border-gray-300');
            summaryPaymentLine.classList.add('border-green-400');
            paymentStep.classList.remove('text-gray-400');
            paymentStep.classList.add('text-green-600');
        }
    }

    // Function to show the current step's content
    function showStep(index) {
        console.log(`[checkoutProcess.html] showStep called for index: ${index}`);
        const checkoutSections = document.querySelectorAll('.checkout'); // Select all steps
        if (checkoutSections.length === 0) {
            console.warn("[checkoutProcess.html] No checkout step sections found. Skipping showStep.");
            return;
        }
        console.log(`[checkoutProcess.html] Found ${checkoutSections.length} checkout sections.`);

        checkoutSections.forEach((stepEl, i) => {
            if (i === index) {
                stepEl.classList.add('active');
                console.log(`[checkoutProcess.html] Adding 'active' to step ${i} (${stepEl.id})`);
            } else {
                stepEl.classList.remove('active');
                console.log(`[checkoutProcess.html] Removing 'active' from step ${i} (${stepEl.id})`);
            }
        });
        currentStepIndex = index;
        updateUIForStep(index);
        updateOrderSummaryDisplays(); // Update summary always when step changes
    }

    // Function to calculate and update order summary displays
    function updateOrderSummaryDisplays() {
        const subTotal = cartItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        const orderTotal = subTotal + DELIVERY_CHARGE;

        const subTotalDisplay = document.getElementById('sub-total-display');
        const deliveryChargesDisplay = document.getElementById('delivery-charges-display');
        const orderTotalDisplay = document.getElementById('order-total-display');
        const itemsCountDisplay = document.getElementById('items-count');

        if (subTotalDisplay) subTotalDisplay.textContent = `₱ ${subTotal.toFixed(2)}`;
        if (deliveryChargesDisplay) deliveryChargesDisplay.textContent = `₱ ${DELIVERY_CHARGE.toFixed(2)}`;
        if (orderTotalDisplay) orderTotalDisplay.textContent = `₱ ${orderTotal.toFixed(2)}`;
        if (itemsCountDisplay) itemsCountDisplay.textContent = `${cartItems.length} Item${cartItems.length !== 1 ? 's' : ''}`;

        // Update product summary in step2
        const summaryItemsContainer = document.getElementById('summary-items-container');
        if (summaryItemsContainer) {
            summaryItemsContainer.innerHTML = ''; // Clear previous items
            cartItems.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.classList.add('flex', 'items-center', 'space-x-4', 'p-3', 'bg-white', 'rounded-xl', 'shadow-sm', 'border', 'border-gray-200');
                itemDiv.innerHTML = `
                    <img src="${item.image}" alt="${item.name}" class="w-20 h-20 object-cover rounded-lg shadow-sm">
                    <div class="flex-1">
                        <h3 class="text-lg font-medium text-gray-900">${item.name}</h3>
                        <p class="text-sm text-gray-600">₱ ${item.price.toFixed(2)} ${item.unit}</p>
                        <p class="text-xs text-gray-500">${item.location}</p>
                        <p class="text-sm text-gray-700 mt-1">Quantity: ${item.quantity}</p>
                    </div>
                `;
                summaryItemsContainer.appendChild(itemDiv);
            });
        }
    }

    // Function to render cart items in step0
    function renderCartItems() {
        console.log("[checkoutProcess.html] renderCartItems called.");
        const cartItemsContainer = document.getElementById('cart-items-container');
        if (!cartItemsContainer) return;

        cartItemsContainer.innerHTML = ''; // Clear existing items

        if (cartItems.length === 0) {
            cartItemsContainer.innerHTML = '<p class="text-center text-gray-500">Your cart is empty.</p>';
        } else {
            cartItems.forEach((item, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.classList.add('flex', 'items-center', 'space-x-4', 'p-3', 'bg-white', 'rounded-xl', 'shadow-sm', 'border', 'border-gray-200');
                itemDiv.innerHTML = `
                    <img src="${item.image}" alt="${item.name}" class="w-20 h-20 object-cover rounded-lg shadow-sm">
                    <div class="flex-1">
                        <h3 class="text-lg font-medium text-gray-900">${item.name}</h3>
                        <p class="text-sm text-gray-600">₱ ${item.price.toFixed(2)} ${item.unit}</p>
                        <p class="text-xs text-gray-500">${item.location}</p>
                        <div class="flex items-center mt-2 space-x-4">
                            <div class="flex items-center bg-gray-100 rounded-full px-2 py-1">
                                <button class="text-red-500 hover:text-red-600 p-1 rounded-full quantity-minus" data-index="${index}"><i class="fas fa-minus text-sm"></i></button>
                                <span class="mx-2 text-gray-800 font-medium quantity-display">${item.quantity}</span>
                                <button class="text-green-500 hover:text-green-600 p-1 rounded-full quantity-plus" data-index="${index}"><i class="fas fa-plus text-sm"></i></button>
                            </div>
                        </div>
                    </div>
                    <div class="flex flex-col items-center justify-end h-full space-y-1">
                        <button class="text-blue-500 hover:text-blue-600 text-sm flex items-center space-x-1 edit-item-btn" data-index="${index}">
                            <i class="fas fa-edit text-xs"></i><span>Edit</span>
                        </button>
                        <button class="text-red-500 hover:text-red-600 text-sm flex items-center space-x-1 remove-item-btn" data-index="${index}">
                            <i class="fas fa-trash-alt text-xs"></i><span>Remove</span>
                        </button>
                    </div>
                `;
                cartItemsContainer.appendChild(itemDiv);
            });

            // Attach listeners to newly rendered quantity controls
            // IMPORTANT: These listeners must be re-attached every time renderCartItems() is called
            // because the innerHTML is reset, removing old elements and their listeners.
            cartItemsContainer.querySelectorAll('.quantity-minus').forEach(button => {
                button.addEventListener('click', (event) => {
                    const index = parseInt(event.currentTarget.dataset.index);
                    if (cartItems[index].quantity > 1) {
                        cartItems[index].quantity--;
                        renderCartItems(); // Re-render to update display and re-attach listeners
                        updateOrderSummaryDisplays();
                    } else {
                        // Option: Show a confirmation modal before removing if quantity drops to 0
                        // For now, directly remove
                        removeItem(index);
                    }
                });
            });

            cartItemsContainer.querySelectorAll('.quantity-plus').forEach(button => {
                button.addEventListener('click', (event) => {
                    const index = parseInt(event.currentTarget.dataset.index);
                    cartItems[index].quantity++;
                    renderCartItems(); // Re-render to update display and re-attach listeners
                    updateOrderSummaryDisplays();
                });
            });

            cartItemsContainer.querySelectorAll('.remove-item-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const index = parseInt(event.currentTarget.dataset.index);
                    removeItem(index); // This also calls renderCartItems and updateOrderSummaryDisplays
                });
            });

            // Edit button functionality can be added here, e.g., open a product detail modal
            cartItemsContainer.querySelectorAll('.edit-item-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const index = parseInt(event.currentTarget.dataset.index);
                    console.log(`Edit item at index: ${index}`, cartItems[index]);
                    // You can implement logic here to open a product detail modal
                    // that allows the user to edit the quantity or other item details.
                });
            });
        }
        updateOrderSummaryDisplays(); // Always update summary after rendering cart items
    }

    // Function to add a product to the cart
    function addProductToCart(product) {
        console.log("[checkoutProcess.html] addProductToCart called with:", product);
        // Check if the product is already in the cart. If so, increment quantity.
        const existingItemIndex = cartItems.findIndex(item => item.name === product.name);
        if (existingItemIndex > -1) {
            cartItems[existingItemIndex].quantity += product.quantity || 1;
        } else {
            cartItems.push({ ...product, quantity: product.quantity || 1 });
        }
        renderCartItems(); // Re-render the cart to show changes
        updateOrderSummaryDisplays(); // Update the totals
        console.log("Current cart:", cartItems);
    }

    // Function to remove a product from the cart by index
    function removeItem(index) {
        if (index > -1 && index < cartItems.length) {
            const removedItem = cartItems.splice(index, 1);
            console.log(`Removed item:`, removedItem[0]);
            renderCartItems(); // Re-render the cart to reflect removal
            updateOrderSummaryDisplays(); // Update the totals
            console.log("Item removed. Current cart:", cartItems);
        }
    }


    // Function to attach event listeners to checkout page elements (non-cart specific)
    function attachCheckoutListeners() {
        console.log("[checkoutProcess.html] attachCheckoutListeners called. Attaching listeners for checkout page.");

        // Event listeners for address/payment card selection
        document.querySelectorAll('.address-card, .payment-option-card').forEach(card => {
            // Remove existing event listener to prevent duplicates
            // This cloning method effectively removes all previously attached event listeners
            const oldCard = card;
            const newCard = oldCard.cloneNode(true);
            oldCard.parentNode.replaceChild(newCard, oldCard); // Replace to clean listeners

            newCard.addEventListener('click', (event) => {
                console.log(`[checkoutProcess.html] Card clicked: ${event.currentTarget.id || event.currentTarget.dataset.paymentType}`);
                const parentContent = event.currentTarget.closest('.content');
                if (parentContent) {
                    parentContent.querySelectorAll('.address-card, .payment-option-card').forEach(d => {
                        d.classList.remove('active', 'bg-green-100', 'border-green-300');
                        d.classList.add('bg-white', 'border-gray-200');
                        const checkmark = d.querySelector('.fa-check-circle');
                        if (checkmark) {
                            checkmark.remove();
                        }
                    });

                    event.currentTarget.classList.add('active', 'bg-green-100', 'border-green-300');
                    event.currentTarget.classList.remove('bg-white', 'border-gray-200');

                    const checkmarkDiv = document.createElement('div');
                    checkmarkDiv.className = 'absolute top-3 right-3 text-green-500';
                    checkmarkDiv.innerHTML = '<i class="fas fa-check-circle text-xl"></i>';
                    event.currentTarget.prepend(checkmarkDiv);
                }
            });
        });

        // Continue button logic
        document.querySelectorAll('.continue-btn').forEach(btn => {
            // Remove existing event listener to prevent duplicates
            const oldBtn = btn;
            const newBtn = oldBtn.cloneNode(true);
            oldBtn.parentNode.replaceChild(newBtn, oldBtn); // Replace to clean listeners

            newBtn.addEventListener('click', () => {
                console.log("[checkoutProcess.html] Continue button clicked.");
                if (currentStepIndex < steps.length - 1) {
                    showStep(currentStepIndex + 1);
                } else {
                    console.log("[checkoutProcess.html] Already at the last step (or next step beyond bounds).");
                }
            });
        });

        // Back button logic
        document.querySelectorAll('.back-btn').forEach(btn => {
            // Remove existing event listener to prevent duplicates
            const oldBtn = btn;
            const newBtn = oldBtn.cloneNode(true);
            oldBtn.parentNode.replaceChild(newBtn, oldBtn); // Replace to clean listeners

            newBtn.addEventListener('click', () => {
                console.log("[checkoutProcess.html] Back button clicked.");
                if (currentStepIndex > 0) {
                    showStep(currentStepIndex - 1);
                } else {
                    console.log("[checkoutProcess.html] Already at the first step.");
                }
            });
        });

        // Checkout button logic (for final step)
        const finalCheckoutBtn = document.querySelector('.checkout-btn');
        if (finalCheckoutBtn) {
            // Remove existing event listener to prevent duplicates
            const oldFinalBtn = finalCheckoutBtn;
            const newFinalBtn = oldFinalBtn.cloneNode(true);
            oldFinalBtn.parentNode.replaceChild(newFinalBtn, oldFinalBtn); // Replace to clean listeners

            newFinalBtn.addEventListener('click', () => {
                console.log('[checkoutProcess.html] Final Checkout Complete! Order Placed Successfully!');
                // Close the modal
                if (window.closeModal) {
                    window.closeModal();
                } else {
                    console.error("window.closeModal is not defined.");
                }
            });
        }
    }

    // Exposed function to initialize checkout with a product from outside (e.g., script.js)
    window.initCheckoutWithProduct = (productDetails) => {
        console.log("[checkoutProcess.html] initCheckoutWithProduct called with:", productDetails);
        cartItems = []; // Clear any previous items
        addProductToCart(productDetails); // Add the new product
        // showStep(0); // This is implicitly called by addProductToCart's renderCartItems
    };

    // Export these functions to the global scope so script.js can call them
    window.attachCheckoutListeners = attachCheckoutListeners;
    window.showStep = showStep;
    window.updateUIForStep = updateUIForStep;
    window.renderCartItems = renderCartItems;
    window.addProductToCart = addProductToCart;
    window.updateOrderSummaryDisplays = updateOrderSummaryDisplays;
</script>
